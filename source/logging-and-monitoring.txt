.. _pymongo-monitoring-logging:

======================
Monitoring and Logging
======================

.. contents:: On this page
   :local:
   :backlinks: none
   :depth: 2
   :class: singlecol

.. facet::
   :name: genre
   :values: reference

.. meta::
   :keywords: debugging, printing, event, subscribe, listener

Overview
--------

In this guide, you can learn how to configure **monitoring** in {+driver-short+}
by using {+driver-short+}'s callback-based interface. Monitoring is the process of
gathering information about your application's performance and resource usage as it runs.
This can help you make informed decisions when designing and debugging your application.

This guide also covers **logging**, which lets you record information obtained during
monitoring to an external log.

Event Types
-----------

The driver provides information about your application by emitting events. You can
listen for driver events to monitor your application.

The type of event that the driver emits depends on the operation being performed.
The following table describes the types of events that the driver emits:

.. list-table::
   :header-rows: 1
   :widths: 30 70

   * - Event Type
     - Description
   * - Command events
     - Events related to MongoDB database commands, such as ``find``, ``insert``,
       ``delete``, and ``count``. To learn how to use {+driver-short+} to run a
       database command, see :ref:`<pymongo-run-command>`. For more information about
       MongoDB database commands, see :manual:`Database Commands </reference/command/>`
       in the {+mdb-server+} manual.

       As a security measure, the driver redacts the contents of some
       command events. This protects the sensitive information contained in these command
       events.

   * - Server Discovery and Monitoring (SDAM) events
     - Events related to changes in the state of the MongoDB deployment.

   * - Connection Pool events
     - Events related to the connection pool held by the driver.

For a complete list of events the driver emits, see the
`pymongo.monitoring <{+api-root+}pymongo/monitoring.html>`__ API documentation.

Listening for Events
--------------------

To monitor an event, you must pass an event listener to your application's ``MongoClient``.
The following steps describe how to monitor your application by using an event listener:

1. Create a class that inherits from one of the event listener base classes
   provided by {+driver-short+}. The base class you choose depends on the type of event
   you want to monitor. For example, to monitor command events, create a class
   that inherits from ``CommandListener``.
#. Implement the methods of the base class that correpond to the events you want to monitor.
#. Pass an instance of your listener class to the ``MongoClient`` constructor.

The following code implements a ``CommandListener`` to listen for command events, a
``ServerListener`` to listen for SDAM events, and a ``ConnectionPoolListener`` to listen for
connection pool events:

.. literalinclude:: /includes/monitoring/monitoring.py
   :language: python
   :start-after: start-monitoring
   :end-before: end-monitoring
   :copyable: true

Logging
-------

{+driver-short+} supports {+language+}'s native logging library. You can configure the logging
verbosity for the following components:

- ``pymongo.command``, which logs command operations
- ``pymongo.connection``, which logs connection management operations
- ``pymongo.serverSelection``, which logs server selection operations

In addition to configuring these options individually, you can configure the global
logging level by setting the log level on ``pymongo``. To learn more about the native
logging library, see the `Python logging library documentation <https://docs.python.org/3/howto/logging.html>`__.

Examples
~~~~~~~~

The following example sets the global logging level to ``INFO``:

.. code-block:: python

   import logging
   logging.getLogger("pymongo").setLevel(logging.INFO)

The following example sets the log level on the ``pymongo.command`` component to
``DEBUG``:

.. code-block:: python

   import logging
   logging.getLogger("pymongo.command").setLevel(logging.DEBUG)

Configuring Truncation
~~~~~~~~~~~~~~~~~~~~~~

If you enable logging for the ``pymongo.command`` component, the resulting logs will
be truncated after 1000 bytes by default. You can configure this truncation limit
by setting the ``MONGODB_LOG_MAX_DOCUMENT_LENGTH`` environment variable to your
desired length, as shown in the following example:

.. code-block:: python

   import os
   os.environ["MONGODB_LOG_MAX_DOCUMENT_LENGTH"] = "2000"

API Documentation
-----------------

To learn more about the methods and classes used to monitor events in the driver, see the
following API documentation:

- `monitoring <{+api-root+}pymongo/monitoring.html>`__
- `MongoClient <{+api-root+}pymongo/mongo_client.html#pymongo.mongo_client.MongoClient>`__